{% extends 'base.html' %}
{% load formatting %}

{% block content %}
<style>
  .parent-card {
    background: #fff;
    border: 1px solid #e8edf2;
    border-radius: 12px;
    padding: 14px;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
  }
  .child-block {
    border-top: 1px solid #eef1f4;
    padding-top: 12px;
    margin-top: 12px;
    border-radius: 10px;
    padding: 12px;
    border: 1px solid #e8edf2;
  }
  .child-block:first-of-type {
    margin-top: 0;
  }
  .child-theme-1 {
    background: linear-gradient(180deg, rgba(18, 96, 156, 0.05), rgba(18, 96, 156, 0.02));
    border-color: rgba(18, 96, 156, 0.25);
  }
  .child-theme-2 {
    background: linear-gradient(180deg, rgba(198, 40, 40, 0.05), rgba(198, 40, 40, 0.02));
    border-color: rgba(198, 40, 40, 0.24);
  }
  .child-theme-3 {
    background: linear-gradient(180deg, rgba(95, 101, 112, 0.07), rgba(95, 101, 112, 0.02));
    border-color: rgba(95, 101, 112, 0.28);
  }
  .child-badge {
    display: inline-block;
    font-size: 12px;
    font-weight: 700;
    color: #fff;
    border-radius: 999px;
    padding: 2px 8px;
    margin-bottom: 6px;
  }
  .child-theme-1 .child-badge { background: #12609c; }
  .child-theme-2 .child-badge { background: #a72525; }
  .child-theme-3 .child-badge { background: #4b5563; }
  @media (max-width: 900px) {
    .child-block {
      padding: 10px;
    }
  }
  .charge-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 14px;
  }
  .charge-table th,
  .charge-table td {
    text-align: left;
    padding: 6px 8px;
    border-bottom: 1px solid #eef1f4;
    vertical-align: top;
  }
  .charge-paid {
    color: #188b4a;
    font-weight: 700;
  }
  .charge-open {
    color: #8b1e1e;
    font-weight: 700;
  }
  .membership-item {
    margin: 3px 0;
  }
  .top-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 0 0 14px;
  }
  .attendance-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    font-weight: 800;
    font-size: 14px;
  }
  .attendance-icon.present {
    color: #fff;
    background: #188b4a;
  }
  .attendance-icon.absent {
    color: #fff;
    background: #b72626;
  }
</style>

<div class="card">
  <h2>Rodičovský přehled</h2>
  <div class="top-actions">
    <a class="btn" href="/parent/profile/">Upravit údaje rodiče a člena</a>
    <a class="btn secondary" href="/registrace/">Přidat další dítě</a>
    {% if children %}
      <a class="btn secondary" href="/parent/child/{{ children.0.id }}/history/">Historie plateb</a>
    {% endif %}
  </div>

  <h3>Seznam členů</h3>
  {% if children %}
    <div class="parent-card">
      {% for child in children %}
        <section class="child-block {% cycle 'child-theme-1' 'child-theme-2' 'child-theme-3' %}">
          <span class="child-badge">Dítě {{ forloop.counter }}</span>
          <strong>{{ child.first_name }} {{ child.last_name }}</strong>
          <div class="muted">VS: {{ child.variable_symbol }}</div>
          <div style="margin-top:6px;">
            <div class="membership-item"><strong>Skupiny:</strong></div>
            {% for membership in child.active_memberships %}
              <div class="membership-item">{{ membership.group }}{% if membership.attendance_option %}, varianta: {{ membership.attendance_option.name }}{% endif %}</div>
            {% empty %}
              <div class="muted">Dítě zatím nemá aktivní skupinu.</div>
            {% endfor %}
            {% for membership in child.ended_memberships %}
              <div class="membership-item" style="color:#8b1e1e;">Ukončeno: {{ membership.group }}</div>
            {% endfor %}
          </div>

          <div style="margin-top:10px;"><strong>Výzvy k úhradě</strong></div>
          {% if child.open_debit_rows %}
            <table class="charge-table">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Událost</th>
                  <th>Částka</th>
                  <th>Stav</th>
                </tr>
              </thead>
              <tbody>
                {% for row in child.open_debit_rows %}
                  <tr>
                    <td>{{ row.occurred_on|date:"d.m.Y" }}</td>
                    <td>{{ row.display_title }}</td>
                    <td>{{ row.amount_czk }} Kč</td>
                    <td>Nezaplaceno</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="muted" style="margin-top:6px;">Bez otevřených plateb.</div>
          {% endif %}

          <div style="margin-top:10px;"><strong>Poslední 3 přítomnosti na tréninku</strong></div>
          {% if child.attendance_preview %}
            <table class="charge-table">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Skupina</th>
                  <th>Stav</th>
                </tr>
              </thead>
              <tbody>
                {% for row in child.attendance_preview %}
                  <tr>
                    <td>{{ row.session.date|date:"d.m.Y" }}</td>
                    <td>{{ row.session.group.sport.name }} - {{ row.session.group.name }}</td>
                    <td>
                      {% if row.present %}
                        <span class="attendance-icon present" title="Přítomen">✓</span>
                      {% else %}
                        <span class="attendance-icon absent" title="Nepřítomen">✕</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="muted" style="margin-top:6px;">Zatím bez záznamu přítomnosti.</div>
          {% endif %}

          <div id="qr-platba-{{ child.id }}" style="margin-top:10px;">
            <strong>QR platba (součet všech otevřených plateb)</strong>
            {% if child.due_total > 0 %}
              <div class="muted" style="margin-top:4px;">Účet: <strong>{{ payment_account_display }}</strong> | VS: <strong>{{ child.variable_symbol }}</strong> | Celkem: <strong>{{ child.due_total|czk_amount }} Kč</strong></div>
              {% if child.qr_image_data %}
                <img
                  alt="QR platba"
                  src="{{ child.qr_image_data }}"
                  style="max-width:220px;border:1px solid #d9e0e8;border-radius:8px;padding:4px;background:#fff;margin-top:6px;"
                >
              {% else %}
                <div class="muted" style="margin-top:6px;">QR se nepodařilo vygenerovat.</div>
              {% endif %}
            {% else %}
              <div class="muted" style="margin-top:6px;">Není evidována otevřená platba.</div>
            {% endif %}
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
            <a class="btn secondary" href="/parent/child/{{ child.id }}#dochazka-dite">Další</a>
            <a class="btn secondary" href="/parent/child/{{ child.id }}/history/">Historie plateb</a>
          </div>
        </section>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">Zatím nemáte registrované dítě.</p>
  {% endif %}

  <h3 style="margin-top:14px;">Dokumenty ke stažení</h3>
  <ul>
    {% for doc in proforma_documents %}
      <li>
        <a href="/parent/proforma/{{ doc.id }}/" target="_blank" rel="noopener">
          Zálohový doklad {{ doc.reference_code|default:"Záloha" }} – {{ doc.child.first_name }} {{ doc.child.last_name }} ({{ doc.amount_czk }} Kč)
        </a>
      </li>
    {% endfor %}
    {% for doc in documents %}
      <li><a href="{{ doc.file.url }}" target="_blank" rel="noopener">{{ doc.title }}</a></li>
    {% empty %}
      {% if not proforma_documents %}
        <li class="muted">Dokumenty zatím nejsou nahrané.</li>
      {% endif %}
    {% endfor %}
  </ul>
</div>
{% endblock %}
