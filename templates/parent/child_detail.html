{% extends 'base.html' %}

{% block content %}
<style>
  .charge-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 14px;
  }
  .charge-table th,
  .charge-table td {
    text-align: left;
    padding: 6px 8px;
    border-bottom: 1px solid #eef1f4;
    vertical-align: top;
  }
  .charge-paid {
    color: #188b4a;
    font-weight: 700;
  }
  .charge-open {
    color: #8b1e1e;
    font-weight: 700;
  }
</style>

<div class="card">
  <h2>Karta dítěte: {{ child.first_name }} {{ child.last_name }}</h2>
  <p class="muted">Unikátní ID: {{ child.variable_symbol }} | VS: {{ child.variable_symbol }}</p>

  <h3>Členství</h3>
  {% if memberships %}
    <ul>
      {% for membership in memberships %}
        <li>Skupina: {{ membership.group }}{% if membership.attendance_option %}, varianta: {{ membership.attendance_option.name }}{% endif %}</li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Zatím bez členství.</p>
  {% endif %}

  <h3>Výzvy k úhradě (prodej)</h3>
  {% if sale_charges %}
    <table class="charge-table">
      <thead>
        <tr>
          <th>Položka</th>
          <th>Částka</th>
          <th>Stav</th>
        </tr>
      </thead>
      <tbody>
        {% for charge in sale_charges %}
          <tr>
            <td>{{ charge.title }}{% if charge.note %}<div class="muted">{{ charge.note }}</div>{% endif %}</td>
            <td>{{ charge.amount_czk }} Kč</td>
            <td>
              {% if charge.paid %}
                <span class="charge-paid">Uhrazeno</span>
              {% else %}
                <span class="charge-open">Čeká na úhradu</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Bez otevřených prodejních položek.</p>
  {% endif %}

  <h3 id="dochazka-dite">Docházka dítěte</h3>
  {% if attendance_rows %}
    <table class="charge-table">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Skupina</th>
          <th>Stav</th>
        </tr>
      </thead>
      <tbody>
        {% for row in attendance_rows %}
          <tr>
            <td>{{ row.session.date|date:"d.m.Y" }}</td>
            <td>{{ row.session.group.sport.name }} - {{ row.session.group.name }}</td>
            <td>
              {% if row.present %}
                <span class="charge-paid">Přítomen</span>
              {% else %}
                <span class="charge-open">Nepřítomen</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Docházka zatím není zadaná.</p>
  {% endif %}

  <h3>Ekonomika ID</h3>
  {% if finance_entries %}
    <table class="charge-table">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Událost</th>
          <th>Částka</th>
          <th>Stav</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in finance_entries %}
          <tr>
            <td>{{ entry.occurred_on|date:"d.m.Y" }}</td>
            <td>
              {% if entry.event_type == 'proforma' or entry.event_type == 'invoice' %}
                Členství
              {% else %}
                {{ entry.title }}
              {% endif %}
              {% if entry.note %}<div class="muted">{{ entry.note }}</div>{% endif %}
            </td>
            <td>{{ entry.amount_czk }} Kč</td>
            <td>
              {% if entry.direction == 'debit' and entry.status == 'open' %}
                Čeká na úhradu
              {% elif entry.status == 'closed' and entry.direction == 'debit' %}
                Uhrazeno
              {% elif entry.status == 'cancelled' %}
                Storno
              {% else %}
                {{ entry.get_status_display }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Bez ekonomických záznamů.</p>
  {% endif %}

  <h3 id="qr-platba">QR platba</h3>
  {% if qr_amount > 0 %}
    {% if selected_entry %}
      <p class="muted">Vybraná položka: <strong>{{ qr_title }}</strong> | Částka: <strong>{{ qr_amount }} Kč</strong> | VS: <strong>{{ child.variable_symbol }}</strong></p>
      {% if selected_entry.event_type == 'proforma' %}
        <p class="muted"><a href="/parent/proforma/{{ selected_entry.id }}/">Otevřít doklad</a></p>
      {% endif %}
      <p class="muted">Celkem otevřené platby: <strong>{{ due_total }} Kč</strong></p>
    {% else %}
      <p class="muted">Celkem k úhradě: <strong>{{ due_total }} Kč</strong> | VS: <strong>{{ child.variable_symbol }}</strong></p>
    {% endif %}
    <p class="muted">Účet: <strong>290625104 / 0300</strong></p>
    <img
      alt="QR platba"
      src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&data={{ 'SPD*1.0*ACC:CZ210300000000290625104*CC:CZK*AM:'|add:qr_amount|add:'*X-VS:'|add:child.variable_symbol|add:'*MSG:'|add:qr_message|urlencode }}"
      style="max-width:240px;border:1px solid #d9e0e8;border-radius:8px;padding:4px;background:#fff;"
    >
  {% else %}
    <p class="muted">Není evidována otevřená platba.</p>
  {% endif %}

  <h3>Dokumenty</h3>
  <ul>
    {% for doc in documents %}
      <li><a href="{{ doc.file.url }}" target="_blank" rel="noopener">{{ doc.title }}</a></li>
    {% empty %}
      <li class="muted">Žádné dokumenty.</li>
    {% endfor %}
  </ul>

  <h3>Upravit údaje dítěte</h3>
  <form method="post">
    {% csrf_token %}
    {% for field in form %}
      <div class="form-row">
        <label>{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
    {% endfor %}
    <button class="btn" type="submit">Uložit</button>
  </form>
</div>
{% endblock %}
