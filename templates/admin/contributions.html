{% extends 'admin/base_admin.html' %}

{% block admin_content %}
<section class="page-hero">
  <h2>Příspěvky</h2>
  <p>Přehled aktivních registrací, variant a částek k úhradě.</p>
</section>

<section class="page-panel">
  <p style="margin:0 0 10px;">
    <a class="btn secondary" href="/admin/payments/">Přijaté platby</a>
  </p>

  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:10px;margin:0 0 12px;">
    <form method="post" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;padding:10px;border:1px solid #e8edf2;border-radius:10px;background:#fafcff;">
      {% csrf_token %}
      <input type="hidden" name="action" value="authorize_proforma_group">
      <div style="min-width:220px;flex:1;">
        <label for="bulk-group-id">Autorizace záloh pro celou skupinu</label>
        <select id="bulk-group-id" name="group_id">
          <option value="">— vyberte skupinu —</option>
          {% for group in groups_nav %}
            <option value="{{ group.id }}">{{ group.sport.name }} - {{ group.name }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn" type="submit">Autorizovat skupinu</button>
    </form>

    <form id="bulk-selected-form" method="post" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap;padding:10px;border:1px solid #e8edf2;border-radius:10px;background:#fafcff;">
      {% csrf_token %}
      <input type="hidden" name="action" value="authorize_proforma_selected">
      <div class="muted" style="min-width:220px;flex:1;">Autorizace záloh pro vybrané děti (zaškrtnuté řádky).</div>
      <button class="btn" id="bulk-selected-submit" type="submit" disabled>Autorizovat vybrané</button>
    </form>
  </div>

  <form method="get" style="margin:10px 0 14px;max-width:420px;">
    <label for="contrib-search">Hledej</label>
    <input id="contrib-search" type="text" name="q" value="{{ query }}" placeholder="Jméno nebo variabilní symbol">
    <input type="hidden" name="sort" value="{{ sort }}">
    <input type="hidden" name="dir" value="{{ direction }}">
  </form>

  <div class="table-wrap">
    <table style="width:100%;border-collapse:collapse;min-width:1100px;">
      <thead>
        <tr style="text-align:left;border-bottom:1px solid #ddd;">
          <th style="padding:8px;width:34px;">
            <input type="checkbox" id="bulk-select-all" title="Vybrat vše">
          </th>
          <th style="padding:8px;"><a href="?sort=name&dir={% if sort == 'name' and direction == 'asc' %}desc{% else %}asc{% endif %}&q={{ query }}">Jméno</a></th>
          <th style="padding:8px;"><a href="?sort=phone&dir={% if sort == 'phone' and direction == 'asc' %}desc{% else %}asc{% endif %}&q={{ query }}">Telefon</a></th>
          <th style="padding:8px;"><a href="?sort=vs&dir={% if sort == 'vs' and direction == 'asc' %}desc{% else %}asc{% endif %}&q={{ query }}">VS</a></th>
          <th style="padding:8px;"><a href="?sort=birth_number&dir={% if sort == 'birth_number' and direction == 'asc' %}desc{% else %}asc{% endif %}&q={{ query }}">Rodné číslo</a></th>
          <th style="padding:8px;"><a href="?sort=group&dir={% if sort == 'group' and direction == 'asc' %}desc{% else %}asc{% endif %}&q={{ query }}">Skupina</a></th>
          <th style="padding:8px;"><a href="?sort=option&dir={% if sort == 'option' and direction == 'asc' %}desc{% else %}asc{% endif %}&q={{ query }}">Varianta</a></th>
          <th style="padding:8px;"><a href="?sort=amount&dir={% if sort == 'amount' and direction == 'asc' %}desc{% else %}asc{% endif %}&q={{ query }}">Plná cena (Kč)</a></th>
          <th style="padding:8px;">Zařazení od</th>
          <th style="padding:8px;">Účtováno měsíců</th>
          <th style="padding:8px;">K úhradě (Kč)</th>
          <th style="padding:8px;">Doklad</th>
          <th style="padding:8px;">Uhrazeno</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr style="border-bottom:1px solid #eee;">
            <td style="padding:8px;">
              <input type="checkbox" class="bulk-select-item" name="selected_membership_ids" value="{{ row.id }}" form="bulk-selected-form">
            </td>
            <td style="padding:8px;">{{ row.child.first_name }} {{ row.child.last_name }}</td>
            <td style="padding:8px;">{{ row.child.parent.phone|default:"-" }}</td>
            <td style="padding:8px;">{{ row.child.variable_symbol }}</td>
            <td style="padding:8px;">{{ row.child.birth_number|default:"-" }}</td>
            <td style="padding:8px;">{{ row.group.sport.name }} - {{ row.group.name }}</td>
            <td style="padding:8px;">
              <select name="attendance_option_id" form="membership-update-{{ row.id }}">
                <option value="">— bez varianty —</option>
                {% for opt in row.group_options %}
                  <option value="{{ opt.id }}" {% if row.attendance_option and row.attendance_option.id == opt.id %}selected{% endif %}>{{ opt.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td style="padding:8px;">
              {% if row.attendance_option %}
                {{ row.base_price }}
              {% else %}
                0
              {% endif %}
            </td>
            <td style="padding:8px;">
              <select name="billing_start_month" form="membership-update-{{ row.id }}">
                <option value="">— auto —</option>
                {% for month_value in row.month_choices %}
                  <option value="{{ month_value }}" {% if row.effective_start|date:"Y-m" == month_value %}selected{% endif %}>{{ month_value|slice:":4" }}/{{ month_value|slice:"5:7" }}</option>
                {% endfor %}
              </select>
            </td>
            <td style="padding:8px;">{{ row.payable_months }}/{{ full_period_months }}</td>
            <td style="padding:8px;">
              {% if row.open_proforma %}
                <strong>{{ row.due_amount }}</strong>
              {% else %}
                <button class="btn secondary" style="padding:4px 8px;" type="submit" form="membership-proforma-{{ row.id }}">
                  {{ row.due_amount }}
                </button>
              {% endif %}
            </td>
            <td style="padding:8px;">
              {% if row.open_proforma %}
                <span title="Záloha">{{ row.open_proforma.reference_code }}</span>
              {% elif row.has_invoice %}
                <span title="Faktura" style="color:#188b4a;font-weight:700;">Fakturováno</span>
              {% else %}
                <span class="muted">Nevystaveno</span>
              {% endif %}
            </td>
            <td style="padding:8px;">
              {% if row.paid %}
                <span title="Uhrazeno" style="color:#188b4a;font-size:18px;line-height:1;">●</span>
              {% else %}
                <span title="Neuhrazeno" style="color:#b0b7c3;font-size:18px;line-height:1;">●</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="13" style="padding:10px;" class="muted">Žádné záznamy.</td>
          </tr>
        {% endfor %}
      </tbody>
      {% if rows %}
      <tfoot>
        <tr style="border-top:2px solid #ddd;font-weight:700;">
          <td colspan="11" style="padding:10px;text-align:right;">Celkem k úhradě</td>
          <td colspan="2" style="padding:10px;">{{ total_due }}</td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
</section>

{% for row in rows %}
  <form id="membership-update-{{ row.id }}" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="update_membership">
    <input type="hidden" name="membership_id" value="{{ row.id }}">
  </form>
  <form id="membership-proforma-{{ row.id }}" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="generate_proforma">
    <input type="hidden" name="membership_id" value="{{ row.id }}">
  </form>
{% endfor %}

<script>
  (function () {
    const input = document.getElementById('contrib-search');
    const bulkButton = document.getElementById('bulk-selected-submit');
    const selectAll = document.getElementById('bulk-select-all');
    const checkItems = Array.from(document.querySelectorAll('.bulk-select-item'));

    const refreshBulkState = () => {
      if (!bulkButton) return;
      const checkedCount = checkItems.filter((el) => el.checked).length;
      bulkButton.disabled = checkedCount === 0;
      if (selectAll) {
        selectAll.checked = checkItems.length > 0 && checkedCount === checkItems.length;
      }
    };

    if (selectAll) {
      selectAll.addEventListener('change', function () {
        checkItems.forEach((el) => { el.checked = selectAll.checked; });
        refreshBulkState();
      });
    }

    checkItems.forEach((el) => {
      el.addEventListener('change', refreshBulkState);
    });
    refreshBulkState();

    if (!input) return;
    let timer = null;
    input.addEventListener('input', function () {
      if (timer) window.clearTimeout(timer);
      timer = window.setTimeout(function () {
        input.form.submit();
      }, 350);
    });

    document.querySelectorAll('select[form^="membership-update-"]').forEach((el) => {
      el.addEventListener('change', function () {
        const formId = el.getAttribute('form');
        const form = formId ? document.getElementById(formId) : null;
        if (form) form.submit();
      });
    });
  })();
</script>
{% endblock %}
