{% extends 'admin/base_admin.html' %}
{% load formatting %}

{% block admin_content %}
<style>
  .eco-table { width:100%; border-collapse:collapse; min-width:1080px; font-size:14px; }
  .eco-table th, .eco-table td { padding:8px; border-bottom:1px solid #eef1f4; text-align:left; vertical-align:middle; }
  .eco-table select, .eco-table input[type="number"] { width:100%; box-sizing:border-box; }
  .records-btn { border:1px solid #1e5f8f; background:#e9f2fb; color:#1e5f8f; border-radius:8px; padding:4px 9px; font-weight:700; cursor:pointer; }
  .records-modal::backdrop { background: rgba(0,0,0,0.35); }
  .records-modal { border:1px solid #cfd8e3; border-radius:12px; max-width:880px; width:92%; padding:0; }
  .records-modal .head { padding:12px; border-bottom:1px solid #e8edf2; display:flex; justify-content:space-between; align-items:center; }
  .records-modal .body { padding:12px; max-height:70vh; overflow:auto; }
  .summary-grid { margin-top:12px; display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px; }
  .summary-item { background:#fff; border:1px solid #e8edf2; border-radius:12px; padding:10px; box-shadow:0 2px 10px rgba(0,0,0,0.06); }
  .summary-item .k { font-size:22px; font-weight:800; line-height:1.1; }
  .summary-item .l { color:#5b6470; margin-top:4px; font-size:13px; }
  @media (max-width: 980px) {
    .summary-grid { grid-template-columns:repeat(2,minmax(0,1fr)); }
  }
</style>

<section class="page-hero">
  <h2>Ekonomika</h2>
  <p>Přehled trenérů, odměn a nákladů.</p>
</section>

<section class="page-panel">
  <form method="get" style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin-bottom:12px;">
    <div>
      <label for="period">Období</label>
      <select id="period" name="period">
        {% for value, label in period_choices %}
          <option value="{{ value }}" {% if period == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="muted">Rozsah: {{ range_start|date:"d.m.Y" }} - {{ range_end|date:"d.m.Y" }}</div>
    <button class="btn secondary" type="submit">Použít</button>
  </form>

  <div class="table-wrap">
    <table class="eco-table">
      <thead>
        <tr>
          <th>Trenér</th>
          <th>Email</th>
          <th>Záznamy</th>
          <th>Typ</th>
          <th>Daň 15 %</th>
          <th>Kč / záznam</th>
          <th>Služby do mzdy</th>
          <th>Hrubá</th>
          <th>Daň</th>
          <th>Výplata</th>
          <th>Proplacení mimo mzdu</th>
          <th>Celkem k proplacení</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <td>{{ row.trainer.first_name }} {{ row.trainer.last_name }}</td>
            <td>{{ row.trainer.email }}</td>
            <td>
              {% if row.attendance_count > 0 %}
                <button type="button" class="records-btn" data-modal-id="records-modal-{{ row.trainer.id }}">{{ row.attendance_count }}</button>
              {% else %}
                <strong>0</strong>
              {% endif %}
              {% if row.attendance_extra_count %}
                <div style="color:#9f1d1d;font-weight:700;font-size:12px;">+{{ row.attendance_extra_count }} mimo přiřazení</div>
              {% endif %}
            </td>
            <td>
              <select name="trainer_payment_mode" form="economics-{{ row.trainer.id }}">
                {% for value, label in payment_choices %}
                  <option value="{{ value }}" {% if row.trainer.trainer_payment_mode == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <label style="display:flex;align-items:center;gap:6px;">
                <input type="checkbox" name="trainer_tax_15_enabled" form="economics-{{ row.trainer.id }}" {% if row.trainer.trainer_tax_15_enabled %}checked{% endif %}>
                <span>15 %</span>
              </label>
            </td>
            <td><input type="number" name="trainer_rate_per_record" form="economics-{{ row.trainer.id }}" min="0" step="1" value="{{ row.trainer.trainer_rate_per_record }}"></td>
            <td>{{ row.service_gross|czk_int }} Kč</td>
            <td><strong>{{ row.gross|czk_int }} Kč</strong></td>
            <td>{{ row.tax|czk_int }} Kč</td>
            <td><strong>{{ row.net|czk_int }} Kč</strong></td>
            <td>{{ row.reimbursement|czk_int }} Kč</td>
            <td><strong>{{ row.payout_total|czk_int }} Kč</strong></td>
          </tr>
        {% empty %}
          <tr><td colspan="12" class="muted">Nejsou vytvořeni žádní trenéři.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

{% for row in rows %}
  <form id="economics-{{ row.trainer.id }}" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="trainer_id" value="{{ row.trainer.id }}">
    <input type="hidden" name="period" value="{{ period }}">
  </form>

  <dialog id="records-modal-{{ row.trainer.id }}" class="records-modal">
    <div class="head">
      <strong>Záznamy docházky – {{ row.trainer.first_name }} {{ row.trainer.last_name }}</strong>
      <button type="button" class="btn secondary" data-close-modal="records-modal-{{ row.trainer.id }}">Zavřít</button>
    </div>
    <div class="body">
      {% if row.records %}
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #eef1f4;">Datum</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #eef1f4;">Trenér</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #eef1f4;">Skupina</th>
            </tr>
          </thead>
          <tbody>
            {% for item in row.records %}
              <tr>
                <td style="padding:6px;border-bottom:1px solid #eef1f4;">{{ item.date|date:"d.m.Y" }}</td>
                <td style="padding:6px;border-bottom:1px solid #eef1f4;">{{ item.trainer_name }}</td>
                <td style="padding:6px;border-bottom:1px solid #eef1f4;">
                  {% if item.extra_access %}<span style="color:#9f1d1d;font-weight:700;">[MIMO]</span> {% endif %}{{ item.group_name }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="muted">V tomto období nejsou záznamy.</p>
      {% endif %}
    </div>
  </dialog>
{% endfor %}

<section class="summary-grid">
  <article class="summary-item">
    <div class="k">{{ total_records }}</div>
    <div class="l">Počet záznamů docházky</div>
  </article>
  <article class="summary-item">
    <div class="k">{{ total_gross|czk_int }} Kč</div>
    <div class="l">Součet hrubé výplaty (Kč)</div>
  </article>
  <article class="summary-item">
    <div class="k">{{ total_tax|czk_int }} Kč</div>
    <div class="l">Součet daně 15 % (Kč)</div>
  </article>
  <article class="summary-item">
    <div class="k">{{ total_net|czk_int }} Kč</div>
    <div class="l">Součet výplaty po dani (Kč)</div>
  </article>
  <article class="summary-item">
    <div class="k">{{ total_reimbursement|czk_int }} Kč</div>
    <div class="l">Součet proplacení mimo mzdu (Kč)</div>
  </article>
  <article class="summary-item">
    <div class="k">{{ total_payout|czk_int }} Kč</div>
    <div class="l">Celkem k proplacení trenérům (Kč)</div>
  </article>
  <article class="summary-item">
    <div class="k">{{ total_expenses|czk_int }} Kč</div>
    <div class="l">Náklady v období (Kč)</div>
  </article>
</section>

<section class="page-panel" style="margin-top:12px;">
  <h3>Nákladové záznamy</h3>
  <form method="post" style="display:grid;grid-template-columns:160px 1fr 160px 180px 1fr auto;gap:8px;align-items:end;margin-bottom:12px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="recurring_expense_add">
    <input type="hidden" name="period" value="{{ period }}">
    <div>
      <label>Začátek</label>
      <input type="date" name="recurring_start_date" value="{{ range_end|date:'Y-m-d' }}">
    </div>
    <div>
      <label>Název opakovaného nákladu</label>
      <input type="text" name="recurring_title" placeholder="Např. pronájem haly" required>
    </div>
    <div>
      <label>Částka (Kč)</label>
      <input type="number" name="recurring_amount_czk" min="0" step="0.01" required>
    </div>
    <div>
      <label>Opakování</label>
      <select name="recurring_recurrence" required>
        <option value="">- vyberte -</option>
        {% for value, label in recurring_choices %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Poznámka</label>
      <input type="text" name="recurring_note" placeholder="Volitelné">
    </div>
    <button class="btn secondary" type="submit">Přidat opakovaný</button>
  </form>

  {% if recurring_expenses %}
    <div class="table-wrap" style="margin-bottom:12px;">
      <table class="eco-table" style="min-width:880px;">
        <thead>
          <tr>
            <th>Název</th>
            <th>Částka</th>
            <th>Opakování</th>
            <th>Začátek</th>
            <th>Další zaúčtování</th>
            <th>Stav</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody>
          {% for item in recurring_expenses %}
            <tr>
              <td>{{ item.title }}</td>
              <td>{{ item.amount_czk|czk_int }} Kč</td>
              <td>{{ item.get_recurrence_display }}</td>
              <td>{{ item.start_date|date:"d.m.Y" }}</td>
              <td>{{ item.next_run_date|date:"d.m.Y" }}</td>
              <td>{% if item.active %}Aktivní{% else %}Pozastaveno{% endif %}</td>
              <td>
                <form method="post" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="recurring_toggle">
                  <input type="hidden" name="period" value="{{ period }}">
                  <input type="hidden" name="recurring_id" value="{{ item.id }}">
                  <button class="btn secondary" type="submit">
                    {% if item.active %}Pozastavit{% else %}Obnovit{% endif %}
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

  <form method="post" style="display:grid;grid-template-columns:160px 1fr 160px 1fr auto;gap:8px;align-items:end;margin-bottom:12px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="expense_add">
    <input type="hidden" name="period" value="{{ period }}">
    <div>
      <label>Datum</label>
      <input type="date" name="expense_date" value="{{ range_end|date:'Y-m-d' }}">
    </div>
    <div>
      <label>Název nákladu</label>
      <input type="text" name="expense_title" placeholder="Např. pronájem haly" required>
    </div>
    <div>
      <label>Částka (Kč)</label>
      <input type="number" name="expense_amount_czk" min="0" step="0.01" required>
    </div>
    <div>
      <label>Poznámka</label>
      <input type="text" name="expense_note" placeholder="Volitelné">
    </div>
    <button class="btn" type="submit">Přidat náklad</button>
  </form>

  <div class="table-wrap">
    <table class="eco-table" style="min-width:760px;">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Typ</th>
          <th>Název</th>
          <th>Částka</th>
          <th>Poznámka</th>
          <th>Vytvořil</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
          <tr>
            <td>{{ expense.expense_date|date:"d.m.Y" }}</td>
            <td>{{ expense.get_expense_type_display }}</td>
            <td>{{ expense.title }}</td>
            <td>{{ expense.amount_czk|czk_int }} Kč</td>
            <td>{{ expense.note|default:"-" }}</td>
            <td>{% if expense.created_by %}{{ expense.created_by.email }}{% else %}-{% endif %}</td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="muted">V tomto období nejsou náklady.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<script>
  (function () {
    const periodSelect = document.getElementById('period');
    if (periodSelect && periodSelect.form) {
      periodSelect.addEventListener('change', function () {
        periodSelect.form.submit();
      });
    }

    document.querySelectorAll('[form^="economics-"]').forEach((control) => {
      control.addEventListener('change', function () {
        const formId = control.getAttribute('form');
        const form = formId ? document.getElementById(formId) : null;
        if (form) form.submit();
      });
    });

    document.querySelectorAll('[data-modal-id]').forEach((btn) => {
      btn.addEventListener('click', function () {
        const id = btn.getAttribute('data-modal-id');
        const modal = id ? document.getElementById(id) : null;
        if (modal && typeof modal.showModal === 'function') modal.showModal();
      });
    });
    document.querySelectorAll('[data-close-modal]').forEach((btn) => {
      btn.addEventListener('click', function () {
        const id = btn.getAttribute('data-close-modal');
        const modal = id ? document.getElementById(id) : null;
        if (modal && typeof modal.close === 'function') modal.close();
      });
    });
  })();
</script>
{% endblock %}
