{% extends 'base.html' %}

{% block content %}
<style>
  .flash,
  .errorlist,
  .errorlist li {
    color: #a11818;
  }
  .errorlist {
    margin: 4px 0 0;
    padding-left: 18px;
    font-weight: 700;
  }
  .multi-row {
    border: 1px solid #e2e6eb;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
    background: #fafbfd;
  }
  .row-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr 1fr auto;
    gap: 8px;
    align-items: end;
  }
  .row-grid .btn {
    white-space: nowrap;
    height: 42px;
  }
  @media (max-width: 900px) {
    .row-grid { grid-template-columns: 1fr; }
    .row-grid .btn { width: 100%; }
  }
  body.mobile-preview .multi-row {
    padding: 8px;
  }
  body.mobile-preview .row-grid {
    grid-template-columns: 1fr;
    gap: 6px;
    align-items: stretch;
  }
  body.mobile-preview .row-grid label {
    margin-bottom: 2px;
  }
  body.mobile-preview .row-grid .btn {
    width: 100%;
    white-space: normal;
    line-height: 1.2;
  }
  .consents-compact {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-bottom: 10px;
  }
  .consent-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
  }
  .consent-item input[type="checkbox"] {
    width: 22px;
    height: 22px;
    margin: 0;
    flex: 0 0 auto;
  }
  .consent-item a {
    text-decoration: underline;
    cursor: pointer;
  }
  .consent-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(10, 16, 24, 0.62);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 14px;
  }
  .consent-modal.open {
    display: flex;
  }
  .consent-modal-box {
    background: #fff;
    width: min(760px, 100%);
    max-height: calc(100vh - 28px);
    border-radius: 12px;
    overflow: auto;
    padding: 14px;
    border: 1px solid #dce3eb;
  }
  .consent-modal-title {
    margin: 4px 0 10px;
  }
  .consent-modal-text {
    white-space: pre-wrap;
    line-height: 1.4;
    margin: 10px 0;
  }
  .consent-modal-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 6px 0;
  }
  @media (max-width: 900px) {
    .consent-modal-box {
      padding: 10px;
      border-radius: 10px;
    }
    .consent-modal-actions .btn {
      flex: 1 1 auto;
    }
  }
</style>

<div class="card">
  <h2>Veřejná registrace dítěte</h2>
  <form method="post" id="public-register-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <h3>Tréninkové skupiny</h3>
    <div class="muted" style="margin-bottom:6px;">Můžete vybrat pro jedno dítě více tréninkových skupin.</div>
    <div class="multi-row">
      <div class="row-grid">
        <div>
          <label>Skupina</label>
          {{ form.group }}
          {{ form.group.errors }}
        </div>
        <div>
          <label>Docházková varianta</label>
          {{ form.attendance_option }}
          {{ form.attendance_option.errors }}
        </div>
        <div>
          <label>Začátek členství od</label>
          {{ form.start_month }}
          {{ form.start_month.errors }}
        </div>
        <button type="button" class="btn secondary" id="add-group-row">+ Přidat další skupinu</button>
      </div>
      {{ form.extra_memberships }}
    </div>
    <div id="extra-groups"></div>

    <h3>Identifikace dítěte</h3>
    <div class="form-row">
      {{ form.birth_number }}
      {{ form.birth_number.errors }}
      <div>
        <a href="#" id="foreign-link" style="font-size:13px;color:#1964b5;">registruji cizince</a>
      </div>
    </div>
    <div class="form-row" id="passport-wrap" style="display:none;">
      {{ form.passport_number }}
      {{ form.passport_number.errors }}
    </div>

    <h3>Údaje o dítěti</h3>
    <div class="muted" style="margin-bottom:8px;">
      Používejte prosím oficiální tvar jména a příjmení (bez&nbsp;zdrobnělin, s diakritikou dle dokladů).
    </div>
    <div class="form-row">{{ form.child_first_name }}</div>
    <div class="form-row">{{ form.child_last_name }}</div>
    <div class="form-row">{{ form.child_phone }}</div>
    {{ form.child_first_name.errors }}{{ form.child_last_name.errors }}{{ form.child_phone.errors }}

    {% if not form.is_parent_registration %}
      <h3>Údaje o rodiči</h3>
      <div class="form-row">{{ form.parent_first_name }}</div>
      <div class="form-row">{{ form.parent_last_name }}</div>
      <div class="form-row">{{ form.parent_email }}</div>
      <div class="form-row">{{ form.parent_phone }}</div>
      <div class="form-row">{{ form.parent_street }}</div>
      <div class="form-row">{{ form.parent_city }}</div>
      <div class="form-row">{{ form.parent_zip }}</div>
      {{ form.parent_first_name.errors }}{{ form.parent_last_name.errors }}{{ form.parent_email.errors }}
      {{ form.parent_phone.errors }}{{ form.parent_street.errors }}{{ form.parent_city.errors }}{{ form.parent_zip.errors }}

      <h3>Rodičovský přístup do SK Mníšecko</h3>
      <div class="muted" style="margin-bottom:8px;">
        Pokud už máte účet, zadejte stejný email a heslo.
      </div>
      <div class="form-row">{{ form.password1 }}{{ form.password1.errors }}</div>
      <div class="form-row">{{ form.password2 }}{{ form.password2.errors }}</div>
    {% else %}
      <div class="card" style="margin:12px 0;background:#f7fbff;">
        Registrujete další dítě pod účtem: <strong>{{ request.user.email }}</strong>.
      </div>
    {% endif %}

    <h3>Souhlasy</h3>
    <div class="consents-compact">
      <label class="consent-item">{{ form.consent_vop }}<a href="#" class="consent-open" data-consent="vop">VOP</a></label>
      <label class="consent-item">{{ form.consent_gdpr }}<a href="#" class="consent-open" data-consent="gdpr">GDPR</a></label>
      <label class="consent-item">{{ form.consent_health }}<a href="#" class="consent-open" data-consent="health">ZDRAVÍ</a></label>
    </div>
    {{ form.consent_vop.errors }}{{ form.consent_gdpr.errors }}{{ form.consent_health.errors }}

    <button class="btn" type="submit">Odeslat registraci</button>
  </form>
</div>

<div class="consent-modal" id="consent-modal">
  <div class="consent-modal-box">
    <div class="consent-modal-actions">
      <button type="button" class="btn secondary" id="consent-back-top">Návrat zpět k registraci</button>
      <button type="button" class="btn" id="consent-accept-top">Odsouhlasit</button>
    </div>
    <h3 class="consent-modal-title" id="consent-modal-title"></h3>
    <div class="consent-modal-text" id="consent-modal-text"></div>
    <div class="consent-modal-actions">
      <button type="button" class="btn secondary" id="consent-back-bottom">Návrat zpět k registraci</button>
      <button type="button" class="btn" id="consent-accept-bottom">Odsouhlasit</button>
    </div>
  </div>
</div>

<script>
  (function() {
    const groupSelect = document.getElementById('id_group');
    const optionSelect = document.getElementById('id_attendance_option');
    const startMonthSelect = document.getElementById('id_start_month');
    const extraWrap = document.getElementById('extra-groups');
    const addBtn = document.getElementById('add-group-row');
    const hidden = document.getElementById('id_extra_memberships');
    const foreignLink = document.getElementById('foreign-link');
    const passportWrap = document.getElementById('passport-wrap');
    const passportInput = document.getElementById('id_passport_number');

    const state = [];

    if (foreignLink && passportWrap) {
      foreignLink.addEventListener('click', (e) => {
        e.preventDefault();
        passportWrap.style.display = 'block';
        if (passportInput) passportInput.focus();
      });
    }

    function syncHidden() {
      if (hidden) hidden.value = JSON.stringify(state);
    }

    function monthOptionsToHtml(months, selectedValue) {
      const options = ['<option value="">— dle aktuálního měsíce —</option>'];
      months.forEach((m) => {
        const selected = m.value === selectedValue ? ' selected' : '';
        options.push(`<option value="${m.value}"${selected}>${m.label}</option>`);
      });
      return options.join('');
    }

    function optionHtml(options, selectedValue) {
      const list = ['<option value="">— vyberte variantu —</option>'];
      options.forEach((opt) => {
        const selected = String(opt.id) === String(selectedValue) ? ' selected' : '';
        list.push(`<option value="${opt.id}"${selected}>${opt.name}</option>`);
      });
      return list.join('');
    }

    async function loadDataForGroup(groupId) {
      if (!groupId) return { options: [], months: [] };
      const resp = await fetch(`/api/attendance-options/?group_id=${encodeURIComponent(groupId)}`);
      return await resp.json();
    }

    async function refreshPrimary() {
      const groupId = groupSelect.value;
      if (!groupId) {
        optionSelect.innerHTML = optionHtml([], '');
        startMonthSelect.innerHTML = monthOptionsToHtml([], '');
        return;
      }
      try {
        const data = await loadDataForGroup(groupId);
        optionSelect.innerHTML = optionHtml(data.options || [], optionSelect.value);
        startMonthSelect.innerHTML = monthOptionsToHtml(data.months || [], startMonthSelect.value);
      } catch (e) {
        optionSelect.innerHTML = optionHtml([], '');
        startMonthSelect.innerHTML = monthOptionsToHtml([], '');
      }
    }

    function renderExtraRows() {
      extraWrap.innerHTML = '';
      state.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'multi-row';
        row.innerHTML = `
          <div class="row-grid">
            <div>
              <label>Další skupina</label>
              <select class="extra-group" data-idx="${idx}">${groupSelect.innerHTML}</select>
            </div>
            <div>
              <label>Docházková varianta</label>
              <select class="extra-option" data-idx="${idx}"></select>
            </div>
            <div>
              <label>Začátek členství od</label>
              <select class="extra-month" data-idx="${idx}"></select>
            </div>
            <button type="button" class="btn secondary extra-remove" data-idx="${idx}">Odebrat</button>
          </div>
        `;
        extraWrap.appendChild(row);

        const groupEl = row.querySelector('.extra-group');
        const optionEl = row.querySelector('.extra-option');
        const monthEl = row.querySelector('.extra-month');
        groupEl.value = item.group_id || '';
        optionEl.innerHTML = optionHtml(item._options || [], item.attendance_option_id || '');
        monthEl.innerHTML = monthOptionsToHtml(item._months || [], item.start_month || '');
      });

      extraWrap.querySelectorAll('.extra-remove').forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.idx);
          state.splice(idx, 1);
          syncHidden();
          renderExtraRows();
        });
      });

      extraWrap.querySelectorAll('.extra-group').forEach((sel) => {
        sel.addEventListener('change', async () => {
          const idx = Number(sel.dataset.idx);
          state[idx].group_id = sel.value;
          state[idx].attendance_option_id = '';
          state[idx].start_month = '';
          try {
            const data = await loadDataForGroup(sel.value);
            state[idx]._options = data.options || [];
            state[idx]._months = data.months || [];
          } catch (e) {
            state[idx]._options = [];
            state[idx]._months = [];
          }
          syncHidden();
          renderExtraRows();
        });
      });

      extraWrap.querySelectorAll('.extra-option').forEach((sel) => {
        sel.addEventListener('change', () => {
          const idx = Number(sel.dataset.idx);
          state[idx].attendance_option_id = sel.value;
          syncHidden();
        });
      });

      extraWrap.querySelectorAll('.extra-month').forEach((sel) => {
        sel.addEventListener('change', () => {
          const idx = Number(sel.dataset.idx);
          state[idx].start_month = sel.value;
          syncHidden();
        });
      });
    }

    if (groupSelect) groupSelect.addEventListener('change', refreshPrimary);
    if (addBtn) {
      addBtn.addEventListener('click', async () => {
        const row = { group_id: '', attendance_option_id: '', start_month: '', _options: [], _months: [] };
        state.push(row);
        syncHidden();
        renderExtraRows();
      });
    }

    const placeholders = {
      id_birth_number: 'Zadejte rodné číslo dítěte (např. 100710/2012)',
      id_passport_number: 'Zadejte číslo pasu dítěte',
      id_child_first_name: 'Zde napište jméno dítěte',
      id_child_last_name: 'Zde napište příjmení dítěte',
      id_child_phone: 'Telefon dítěte (volitelné)',
      id_parent_first_name: 'Jméno rodiče',
      id_parent_last_name: 'Příjmení rodiče',
      id_parent_email: 'E-mail rodiče',
      id_parent_phone: 'Telefon rodiče',
      id_parent_street: 'Ulice a číslo domu rodiče',
      id_parent_city: 'Město',
      id_parent_zip: 'PSČ',
      id_password1: 'Heslo',
      id_password2: 'Heslo znovu',
    };
    Object.entries(placeholders).forEach(([id, text]) => {
      const input = document.getElementById(id);
      if (input) input.placeholder = text;
    });

    const parentStreet = document.getElementById('id_parent_street');
    const parentCity = document.getElementById('id_parent_city');
    const parentZip = document.getElementById('id_parent_zip');
    if (parentStreet && parentCity && parentZip) {
      const listId = 'street-address-suggestions';
      let dataList = document.getElementById(listId);
      if (!dataList) {
        dataList = document.createElement('datalist');
        dataList.id = listId;
        document.body.appendChild(dataList);
      }
      parentStreet.setAttribute('list', listId);

      let itemsByLabel = {};
      let timer = null;
      const loadAddressSuggestions = async () => {
        const q = (parentStreet.value || '').trim();
        if (q.length < 4) {
          dataList.innerHTML = '';
          itemsByLabel = {};
          return;
        }
        try {
          const resp = await fetch(`/api/address-lookup/?q=${encodeURIComponent(q)}`);
          const data = await resp.json();
          const rows = data.results || [];
          itemsByLabel = {};
          dataList.innerHTML = rows.map((row) => {
            itemsByLabel[row.label] = row;
            return `<option value="${row.label}"></option>`;
          }).join('');
        } catch (err) {
          dataList.innerHTML = '';
          itemsByLabel = {};
        }
      };

      const applyAddress = () => {
        const selected = (parentStreet.value || '').trim();
        const row = itemsByLabel[selected];
        if (!row) return;
        parentStreet.value = row.street || selected;
        if (row.city) parentCity.value = row.city;
        if (row.postcode) parentZip.value = String(row.postcode).replace(/\s+/g, '');
      };

      parentStreet.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(loadAddressSuggestions, 250);
      });
      parentStreet.addEventListener('change', applyAddress);
      parentStreet.addEventListener('blur', applyAddress);
    }

    const consentModal = document.getElementById('consent-modal');
    const consentTitle = document.getElementById('consent-modal-title');
    const consentText = document.getElementById('consent-modal-text');
    const consentConfig = {
      vop: {
        checkboxId: 'id_consent_vop',
        title: 'VOP',
        text: `{{ app_settings.consent_vop_text|default:"Souhlasím s VOP"|escapejs }}`,
      },
      gdpr: {
        checkboxId: 'id_consent_gdpr',
        title: 'GDPR',
        text: `{{ app_settings.consent_gdpr_text|default:"Souhlasím se zpracováním osobních údajů (GDPR)"|escapejs }}`,
      },
      health: {
        checkboxId: 'id_consent_health',
        title: 'ZDRAVÍ',
        text: `{{ app_settings.consent_health_text|default:"Potvrzuji vhodný zdravotní stav dítěte pro sportovní činnost"|escapejs }}`,
      },
    };
    let activeConsent = null;

    function closeConsentModal() {
      activeConsent = null;
      consentModal.classList.remove('open');
      document.body.style.overflow = '';
    }

    function acceptConsent() {
      if (!activeConsent) return closeConsentModal();
      const cfg = consentConfig[activeConsent];
      const cb = cfg ? document.getElementById(cfg.checkboxId) : null;
      if (cb) cb.checked = true;
      closeConsentModal();
    }

    document.querySelectorAll('.consent-open').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const key = link.dataset.consent;
        const cfg = consentConfig[key];
        if (!cfg) return;
        activeConsent = key;
        consentTitle.textContent = cfg.title;
        consentText.textContent = cfg.text || '';
        consentModal.classList.add('open');
        document.body.style.overflow = 'hidden';
      });
    });

    ['consent-back-top', 'consent-back-bottom'].forEach((id) => {
      const btn = document.getElementById(id);
      if (btn) btn.addEventListener('click', closeConsentModal);
    });
    ['consent-accept-top', 'consent-accept-bottom'].forEach((id) => {
      const btn = document.getElementById(id);
      if (btn) btn.addEventListener('click', acceptConsent);
    });
    if (consentModal) {
      consentModal.addEventListener('click', (e) => {
        if (e.target === consentModal) closeConsentModal();
      });
    }

    refreshPrimary();
  })();
</script>
{% endblock %}
